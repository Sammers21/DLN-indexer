name: DLN Release & Deploy

on:
  push:
    branches: [main]
  pull_request:

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      indexer: ${{ steps.check.outputs.indexer }}
      api: ${{ steps.check.outputs.api }}
      dashboard: ${{ steps.check.outputs.dashboard }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Check for changes or release flags
        id: check
        run: |
          MSG="${{ github.event.head_commit.message }}"

          # Check release flags
          if echo "$MSG" | grep -q "release-indexer"; then
            echo "indexer=true" >> $GITHUB_OUTPUT
          else
            echo "indexer=false" >> $GITHUB_OUTPUT
          fi
          if echo "$MSG" | grep -q "release-api"; then
            echo "api=true" >> $GITHUB_OUTPUT
          else
            echo "api=false" >> $GITHUB_OUTPUT
          fi
          if echo "$MSG" | grep -q "release-dashboard"; then
            echo "dashboard=true" >> $GITHUB_OUTPUT
          else
            echo "dashboard=false" >> $GITHUB_OUTPUT
          fi

          # Override with file-based detection for PRs
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} 2>/dev/null || echo "")
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          fi

          if echo "$CHANGED_FILES" | grep -q "^apps/indexer/\|^packages/shared/"; then
            echo "indexer=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -q "^apps/api/\|^packages/shared/"; then
            echo "api=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -q "^apps/dashboard/"; then
            echo "dashboard=true" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-changes
    if: needs.check-changes.outputs.indexer == 'true' || needs.check-changes.outputs.api == 'true' || needs.check-changes.outputs.dashboard == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: indexer
            file: apps/indexer/Dockerfile
            flag: indexer
          - name: api
            file: apps/api/Dockerfile
            flag: api
          - name: dashboard
            file: apps/dashboard/Dockerfile
            flag: dashboard
    steps:
      - uses: actions/checkout@v4
        if: needs.check-changes.outputs[matrix.flag] == 'true'

      - name: Configure insecure registry (HTTP)
        if: needs.check-changes.outputs[matrix.flag] == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          sudo mkdir -p /etc/docker
          cat <<'EOF' | sudo tee /etc/docker/daemon.json >/dev/null
          {"insecure-registries":["${{ secrets.DOCKER_REGISTRY }}"]}
          EOF
          sudo systemctl restart docker || sudo service docker restart
          docker info | sed -n '/Insecure Registries:/,/Live Restore Enabled:/p'

      - name: Set up Docker Buildx (push)
        if: needs.check-changes.outputs[matrix.flag] == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
          config-inline: |
            [registry."${{ secrets.DOCKER_REGISTRY }}"]
              http = true
              insecure = true

      - name: Set up Docker Buildx (PR)
        if: needs.check-changes.outputs[matrix.flag] == 'true' && github.event_name == 'pull_request'
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Log in to registry
        if: needs.check-changes.outputs[matrix.flag] == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_REGISTRY_USER }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      - name: Build and push ${{ matrix.name }} image
        if: needs.check-changes.outputs[matrix.flag] == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.file }}
          push: true
          tags: ${{ secrets.DOCKER_REGISTRY }}/dln-${{ matrix.name }}:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/dln-${{ matrix.name }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/dln-${{ matrix.name }}:buildcache,mode=max

      - name: Build ${{ matrix.name }} image (PR)
        if: needs.check-changes.outputs[matrix.flag] == 'true' && github.event_name == 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.file }}
          push: false
          tags: dln-${{ matrix.name }}:pr-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-env:
    needs: [check-changes, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && (contains(github.event.head_commit.message, 'release-indexer') || contains(github.event.head_commit.message, 'release-api'))
    runs-on: ubuntu-latest
    steps:
      - name: Write .env file to production server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.APP_HOST }}
          username: ${{ secrets.SSH_HOST_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            mkdir -p /opt/dln
            cat > /opt/dln/.env << 'ENVEOF'
            ${{ secrets.DLN_ENV_FILE }}
            ENVEOF

  deploy-indexer:
    needs: [check-changes, build, deploy-env]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, 'release-indexer')
    runs-on: ubuntu-latest
    steps:
      - name: Deploy indexer to production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.APP_HOST }}
          username: ${{ secrets.SSH_HOST_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            docker pull ${{ secrets.DOCKER_REGISTRY }}/dln-indexer:latest
            docker stop dln-indexer || true
            docker rm -f dln-indexer || true
            docker run --restart=always --name dln-indexer -d \
              --network host \
              --env-file /opt/dln/.env \
              ${{ secrets.DOCKER_REGISTRY }}/dln-indexer:latest
            docker image prune -f || true

  deploy-api:
    needs: [check-changes, build, deploy-env]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, 'release-api')
    runs-on: ubuntu-latest
    steps:
      - name: Deploy API to production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.APP_HOST }}
          username: ${{ secrets.SSH_HOST_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            docker pull ${{ secrets.DOCKER_REGISTRY }}/dln-api:latest
            docker stop dln-api || true
            docker rm -f dln-api || true
            docker run --restart=always --name dln-api -d \
              --network host \
              --env-file /opt/dln/.env \
              ${{ secrets.DOCKER_REGISTRY }}/dln-api:latest
            docker image prune -f || true

  deploy-dashboard:
    needs: [check-changes, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, 'release-dashboard')
    runs-on: ubuntu-latest
    steps:
      - name: Deploy dashboard to production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.APP_HOST }}
          username: ${{ secrets.SSH_HOST_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            docker pull ${{ secrets.DOCKER_REGISTRY }}/dln-dashboard:latest
            docker stop dln-dashboard || true
            docker rm -f dln-dashboard || true
            docker run --restart=always --name dln-dashboard -d \
              --add-host=host.docker.internal:host-gateway \
              -p 8081:80 \
              ${{ secrets.DOCKER_REGISTRY }}/dln-dashboard:latest
            docker image prune -f || true
